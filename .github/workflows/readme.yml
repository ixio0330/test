name: Update README Links

on:
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Get email
        id: get-email
        run: |
            EMAIL=$(gh api /user/emails --paginate --jq '[.[] | select(.primary == true) | .email][0]')
            echo "::set-output name=email::$EMAIL"
        env: 
            GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      - name: Update README
        run: |
          for file in $(git diff --name-only origin/main --diff-filter=A -- '*.md'); do
            folder=$(dirname "$file")
            filename=$(basename "$file" .md)
            link="[${filename}](https://github.com/${{ github.repository }}/blob/main/${folder}/${filename}.md)"

            if [[ -f "${folder}/README.md" ]]; then
              echo "- ${link}" >> "${folder}/README.md"
            else
              echo "# ${folder}" > "${folder}/README.md"
              echo "- ${link}" >> "${folder}/README.md"
            fi
            git add "${folder}/README.md"
          done
      - name: Commit and push changes
        run: |
          git config --local user.name "$GITHUB_ACTOR"
          git config --local user.email "${{ steps.get-email.outputs.email }}"
          git diff-index --quiet HEAD || git commit -m "üìù Update README with new link"
          git push
        env: 
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
